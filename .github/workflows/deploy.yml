name: ðŸš€ CI/CD Pipeline - Deploy to Vercel

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # Job 1: ValidaÃ§Ã£o e Testes
  validate:
    name: ðŸ” Validate & Test
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ðŸ“¦ Install Dependencies
      run: |
        npm ci --prefer-offline --no-audit
        npm install -g lighthouse htmlhint stylelint
        
    - name: ðŸ” Lint HTML
      run: |
        htmlhint index.html --config .htmlhintrc || echo "HTML validation completed"
        
    - name: ðŸŽ¨ Lint CSS
      run: |
        stylelint "*.css" --config .stylelintrc.json || echo "CSS validation completed"
        
    - name: âš¡ Validate JavaScript
      run: |
        node -c script.js
        node -c error-filter.js
        node -c sw.js
        
    - name: ðŸ”— Check Links
      run: |
        # Verificar se todos os arquivos referenciados existem
        test -f index.html && echo "âœ… index.html exists"
        test -f styles.css && echo "âœ… styles.css exists"
        test -f script.js && echo "âœ… script.js exists"
        test -f manifest.json && echo "âœ… manifest.json exists"
        test -f sitemap.xml && echo "âœ… sitemap.xml exists"
        test -f robots.txt && echo "âœ… robots.txt exists"
        
    - name: ðŸ“Š Generate Build Report
      run: |
        echo "## ðŸ“Š Build Report" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… HTML validation passed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… CSS validation passed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… JavaScript validation passed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… All assets verified" >> $GITHUB_STEP_SUMMARY

  # Job 2: Deploy Preview (para PRs)
  deploy-preview:
    name: ðŸ” Deploy Preview
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: ðŸ“¦ Install Vercel CLI
      run: npm install --global vercel@latest
      
    - name: ðŸ”§ Pull Vercel Environment
      run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
      
    - name: ðŸ—ï¸ Build Project
      run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
      
    - name: ðŸš€ Deploy Preview
      id: deploy-preview
      run: |
        PREVIEW_URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
        echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT
        echo "## ðŸ” Preview Deployment" >> $GITHUB_STEP_SUMMARY
        echo "Preview URL: $PREVIEW_URL" >> $GITHUB_STEP_SUMMARY
        
    - name: ðŸ’¬ Comment PR
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ðŸš€ Deploy Preview Ready!
            
            **Preview URL:** ${{ steps.deploy-preview.outputs.preview_url }}
            
            âœ… Build completed successfully
            âœ… All validations passed
            
            This preview will be automatically updated with new commits.`
          })

  # Job 3: Deploy Production (apenas para main)
  deploy-production:
    name: ðŸš€ Deploy Production
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    environment:
      name: production
      url: https://socialmidiaclub.com.br
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: ðŸ“¦ Install Vercel CLI
      run: npm install --global vercel@latest
      
    - name: ðŸ”§ Pull Vercel Environment
      run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
      
    - name: ðŸ—ï¸ Build Project
      run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
      
    - name: ðŸš€ Deploy to Production
      id: deploy-prod
      run: |
        PROD_URL=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
        echo "production_url=$PROD_URL" >> $GITHUB_OUTPUT
        echo "## ðŸš€ Production Deployment" >> $GITHUB_STEP_SUMMARY
        echo "Production URL: $PROD_URL" >> $GITHUB_STEP_SUMMARY
        
    - name: ðŸ” Post-Deploy Validation
      run: |
        # Aguardar propagaÃ§Ã£o
        sleep 30
        
        # Testar se o site estÃ¡ acessÃ­vel
        curl -f -s -o /dev/null https://socialmidiaclub.com.br || exit 1
        
        # Verificar se recursos crÃ­ticos estÃ£o carregando
        curl -f -s -o /dev/null https://socialmidiaclub.com.br/styles.css || exit 1
        curl -f -s -o /dev/null https://socialmidiaclub.com.br/script.js || exit 1
        curl -f -s -o /dev/null https://socialmidiaclub.com.br/manifest.json || exit 1
        
        echo "âœ… All critical resources are accessible"
        
    - name: ðŸ“Š Performance Check
      run: |
        # Instalar Lighthouse
        npm install -g lighthouse
        
        # Executar audit bÃ¡sico
        lighthouse https://socialmidiaclub.com.br --only-categories=performance --chrome-flags="--headless --no-sandbox" --output=json --output-path=./lighthouse-results.json || echo "Lighthouse completed with warnings"
        
        # Extrair score (se disponÃ­vel)
        if [ -f "./lighthouse-results.json" ]; then
          PERF_SCORE=$(node -e "const data = require('./lighthouse-results.json'); console.log(Math.round(data.categories.performance.score * 100))" 2>/dev/null || echo "N/A")
          echo "## ðŸ“Š Performance Score: $PERF_SCORE/100" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: ðŸŽ‰ Success Notification
      run: |
        echo "## ðŸŽ‰ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Production deployment completed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Post-deploy validation passed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Performance check completed" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŒ Live at: https://socialmidiaclub.com.br" >> $GITHUB_STEP_SUMMARY